<%- include('partials/header') %>

<body class="bg-dark-gray">

<main class="planner-main">

    <section class="event-planner-header">
        <h1>Event <span>Planner</span></h1>
        <p>Track important events and never miss a deadline</p>
    </section>

    <section class="event-summary">
        <div class="summary-card"><h2 id="upcoming-count">0</h2><p>Upcoming</p></div>
        <div class="summary-card"><h2 id="completed-count">0</h2><p>Completed</p></div>
        <div class="summary-card"><h2 id="total-count">0</h2><p>Total</p></div>
    </section>

    <section class="add-event">
        <h2>Add New Event</h2>
        <form id="event-form">
            <div class="form-group">
                <h3>Event Title</h3>
                <input type="text" id="event-title" placeholder="Enter event title" required>
            </div>
            <div class="form-group">
                <h3>Date</h3>
                <input type="date" id="event-date" required>
            </div>
            <div class="form-group">
                <h3>Time</h3>
                <input type="time" id="event-time" required>
            </div>
            <button type="submit" class="add-btn">+ Add</button>
        </form>
    </section>

    <section class="upcoming-events">
        <h2>Upcoming Events</h2>
        <div id="event-list" class="event-list"></div>
    </section>

</main>

<script>
    const eventList = document.getElementById("event-list");
    const upcomingCount = document.getElementById("upcoming-count");
    const completedCount = document.getElementById("completed-count");
    const totalCount = document.getElementById("total-count");
    const form = document.getElementById("event-form");

    let events = [];

    async function loadEvents() {
        try {
            // GET: Read all events from the API
            const res = await fetch('http://localhost:3000/api/events');
            if (!res.ok) throw new Error("Could not load events.");
            events = await res.json();
            renderEvents();
        } catch (err) {
            console.error("Error loading events:", err);
            events = [];
            renderEvents();
        }
    }

    async function deleteEvent(eventId) {
        try {
            // DELETE: Delete an event using its _id
            const res = await fetch(`http://localhost:3000/api/events/${eventId}`, {
                method: 'DELETE'
            });
            if (!res.ok) throw new Error('Failed to delete event.');
            await loadEvents();
        } catch (e) {
            console.error('Error deleting event:', e);
            alert('Could not delete event. (Ensure MongoDB is running)');
        }
    }

    function renderEvents() {
        eventList.innerHTML = "";
        
        if (events.length === 0) {
            eventList.innerHTML = "<p>No events yet. Add one above!</p>";
            upcomingCount.textContent = "0";
            completedCount.textContent = "0";
            totalCount.textContent = "0";
            return;
        }

        const now = new Date();
        let upcoming = 0, completed = 0;

        events.forEach((event) => {
            const eventDate = new Date(`${event.date}T${event.time}`);
            const timeDiff = eventDate - now;
            const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

            if (daysLeft >= 0) upcoming++;
            else completed++;

            const item = document.createElement("div");
            item.classList.add("event-item");
            
            item.innerHTML = `
                <div class="event-info">
                    <h3>${event.title}</h3>
                    <div class="event-meta">
                        <p><img class="calendar_icon" src="/images/image 11.png"> ${event.date}</p>
                        <p><img class="Clock_icon" src="/images/Clock 6.png"> ${event.time}</p>
                    </div>
                </div>
                <div class="event-actions">
                    <span>${daysLeft >= 0 ? `${daysLeft} day(s) left` : "Completed"}</span>
                    <button class="delete-btn" data-id="${event._id}">üóëÔ∏è</button>
                </div>
            `;

            eventList.appendChild(item);
        });

        totalCount.textContent = events.length;
        upcomingCount.textContent = upcoming;
        completedCount.textContent = completed;

        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", e => {
                const id = e.target.dataset.id;
                if (confirm('Are you sure you want to delete this event?')) {
                    deleteEvent(id);
                }
            });
        });
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = document.getElementById("event-title").value.trim();
        const date = document.getElementById("event-date").value;
        const time = document.getElementById("event-time").value;

        if (!title || !date || !time) return alert("Please fill all fields!");

        const newEvent = { title, date, time };
        
        try {
            // POST: Create a new event via API
            const res = await fetch('http://localhost:3000/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newEvent)
            });
            if (!res.ok) throw new Error('Failed to add event.');

            form.reset();
            await loadEvents();

        } catch (e) {
            console.error('Error adding event:', e);
            alert('Could not add event. (Ensure MongoDB is running)');
        }
    });

    loadEvents();
</script>

<%- include('partials/footer') %>